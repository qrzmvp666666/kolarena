<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¯„è®ºåŠŸèƒ½æµ‹è¯•</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: monospace;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #1a1a1a;
      color: #fff;
    }
    button {
      background: #00ffff;
      color: #000;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      margin: 5px;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    textarea {
      width: 100%;
      height: 100px;
      margin: 10px 0;
      padding: 10px;
      background: #2a2a2a;
      color: #fff;
      border: 1px solid #444;
    }
    .log {
      background: #2a2a2a;
      padding: 15px;
      margin: 10px 0;
      border-left: 3px solid #00ffff;
      white-space: pre-wrap;
      font-size: 12px;
    }
    .error {
      border-left-color: #ff0000;
      color: #ff6666;
    }
    .success {
      border-left-color: #00ff00;
      color: #66ff66;
    }
  </style>
</head>
<body>
  <h1>ğŸ§ª è¯„è®ºåŠŸèƒ½æµ‹è¯•</h1>
  
  <div>
    <h3>Supabase é…ç½®</h3>
    <input type="text" id="supabaseUrl" placeholder="Supabase URL" style="width: 100%; padding: 10px; background: #2a2a2a; color: #fff; border: 1px solid #444; margin: 5px 0;">
    <input type="text" id="supabaseKey" placeholder="Supabase Anon Key" style="width: 100%; padding: 10px; background: #2a2a2a; color: #fff; border: 1px solid #444; margin: 5px 0;">
    <button onclick="initSupabase()">åˆå§‹åŒ– Supabase</button>
  </div>

  <hr>

  <div>
    <h3>ç”¨æˆ·æ“ä½œ</h3>
    <input type="email" id="email" placeholder="é‚®ç®±" style="width: calc(50% - 10px); padding: 10px; background: #2a2a2a; color: #fff; border: 1px solid #444; margin: 5px;">
    <input type="password" id="password" placeholder="å¯†ç " style="width: calc(50% - 10px); padding: 10px; background: #2a2a2a; color: #fff; border: 1px solid #444; margin: 5px;">
    <br>
    <button onclick="signIn()">ç™»å½•</button>
    <button onclick="checkAuth()">æ£€æŸ¥ç™»å½•çŠ¶æ€</button>
    <button onclick="signOut()">ç™»å‡º</button>
  </div>

  <hr>

  <div>
    <h3>è¯„è®ºæ“ä½œ</h3>
    <textarea id="commentContent" placeholder="è¾“å…¥è¯„è®ºå†…å®¹..."></textarea>
    <button onclick="createComment()">åˆ›å»ºè¯„è®º</button>
    <button onclick="getComments()">è·å–è¯„è®ºåˆ—è¡¨</button>
    <button onclick="subscribeToComments()">è®¢é˜…å®æ—¶æ›´æ–°</button>
  </div>

  <div id="logs"></div>

  <script>
    let supabase = null;
    let realtimeChannel = null;

    function log(message, type = 'info') {
      const logs = document.getElementById('logs');
      const div = document.createElement('div');
      div.className = `log ${type}`;
      div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logs.insertBefore(div, logs.firstChild);
      console.log(message);
    }

    function initSupabase() {
      const url = document.getElementById('supabaseUrl').value;
      const key = document.getElementById('supabaseKey').value;
      
      if (!url || !key) {
        log('è¯·å¡«å†™ Supabase URL å’Œ Anon Key', 'error');
        return;
      }

      try {
        supabase = window.supabase.createClient(url, key);
        log('Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸï¼', 'success');
      } catch (error) {
        log('åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
      }
    }

    async function signIn() {
      if (!supabase) {
        log('è¯·å…ˆåˆå§‹åŒ– Supabase', 'error');
        return;
      }

      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      try {
        const { data, error } = await supabase.auth.signInWithPassword({
          email,
          password
        });

        if (error) throw error;
        log('ç™»å½•æˆåŠŸï¼ç”¨æˆ·: ' + data.user.email, 'success');
        log('User ID: ' + data.user.id, 'info');
      } catch (error) {
        log('ç™»å½•å¤±è´¥: ' + error.message, 'error');
      }
    }

    async function checkAuth() {
      if (!supabase) {
        log('è¯·å…ˆåˆå§‹åŒ– Supabase', 'error');
        return;
      }

      try {
        const { data: { session }, error } = await supabase.auth.getSession();
        if (error) throw error;

        if (session) {
          log('å·²ç™»å½• - ç”¨æˆ·: ' + session.user.email, 'success');
          log('User ID: ' + session.user.id, 'info');
        } else {
          log('æœªç™»å½•', 'info');
        }
      } catch (error) {
        log('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥: ' + error.message, 'error');
      }
    }

    async function signOut() {
      if (!supabase) return;
      await supabase.auth.signOut();
      log('å·²ç™»å‡º', 'info');
    }

    async function createComment() {
      if (!supabase) {
        log('è¯·å…ˆåˆå§‹åŒ– Supabase', 'error');
        return;
      }

      const content = document.getElementById('commentContent').value;
      if (!content.trim()) {
        log('è¯·è¾“å…¥è¯„è®ºå†…å®¹', 'error');
        return;
      }

      try {
        log('è°ƒç”¨ create_comment RPC...', 'info');
        const { data, error } = await supabase.rpc('create_comment', {
          p_target_type: 'global',
          p_target_id: null,
          p_content: content.trim(),
          p_display_time: new Date().toISOString()
        });

        if (error) {
          log('RPC é”™è¯¯: ' + JSON.stringify(error, null, 2), 'error');
          throw error;
        }

        log('è¯„è®ºåˆ›å»ºæˆåŠŸï¼\n' + JSON.stringify(data, null, 2), 'success');
        document.getElementById('commentContent').value = '';
      } catch (error) {
        log('åˆ›å»ºè¯„è®ºå¤±è´¥: ' + error.message, 'error');
      }
    }

    async function getComments() {
      if (!supabase) {
        log('è¯·å…ˆåˆå§‹åŒ– Supabase', 'error');
        return;
      }

      try {
        log('è·å–è¯„è®ºåˆ—è¡¨...', 'info');
        const { data, error } = await supabase.rpc('get_comments', {
          p_target_type: 'global',
          p_target_id: null,
          p_limit: 100
        });

        if (error) {
          log('RPC é”™è¯¯: ' + JSON.stringify(error, null, 2), 'error');
          throw error;
        }

        log(`æˆåŠŸè·å– ${data.length} æ¡è¯„è®º:\n${JSON.stringify(data, null, 2)}`, 'success');
      } catch (error) {
        log('è·å–è¯„è®ºå¤±è´¥: ' + error.message, 'error');
      }
    }

    async function subscribeToComments() {
      if (!supabase) {
        log('è¯·å…ˆåˆå§‹åŒ– Supabase', 'error');
        return;
      }

      if (realtimeChannel) {
        await supabase.removeChannel(realtimeChannel);
        log('å·²å–æ¶ˆè®¢é˜…', 'info');
      }

      try {
        log('è®¢é˜…è¯„è®ºå®æ—¶æ›´æ–°...', 'info');
        realtimeChannel = supabase
          .channel('test-comments')
          .on(
            'postgres_changes',
            {
              event: '*',
              schema: 'public',
              table: 'comments'
            },
            (payload) => {
              log('å®æ—¶æ›´æ–°æ”¶åˆ°:\n' + JSON.stringify(payload, null, 2), 'success');
            }
          )
          .subscribe((status) => {
            log('è®¢é˜…çŠ¶æ€: ' + status, status === 'SUBSCRIBED' ? 'success' : 'info');
          });
      } catch (error) {
        log('è®¢é˜…å¤±è´¥: ' + error.message, 'error');
      }
    }
  </script>
</body>
</html>
